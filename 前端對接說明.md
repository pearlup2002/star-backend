# 星盤分析 API 更新說明

## 📋 更新日期
2025-01-07（最新更新：添加宮位分析功能）

## 🎯 主要變更

### 1. API 返回結構變更

**新的返回結構：**
```json
{
  "chart": {
    "western": {
      "planets": {...},
      "elements": {...},
      "rising": "...",
      "distribution": [...],
      "houses": [
        {"house": 1, "sign": "白羊座"},
        {"house": 2, "sign": "金牛座"},
        ...
      ]
    },
    "chinese": {
      "five_elements": {
        "金": 25,
        "木": 12,
        "水": 38,
        "火": 13,
        "土": 12
      },
      "bazi_text": [...],
      "self_element": "..."
    }
  },
  "attachment_analysis": "依戀模式分析內容（約300字，純文字）",
  "deep_analysis": "星盤深度探索內容（約1000字，包含【標題】格式的小標題）",
  "houses_analysis": "宮位分析內容（每一宮約100字，共12宮，包含【標題】格式）",
  "ai_report": "與 deep_analysis 相同（向後兼容，建議改用 deep_analysis）"
}
```

---

## 🔑 重要字段說明

### 1. `attachment_analysis` - 依戀模式分析

**用途：** 顯示在「依戀類型傾向」卡片中

**格式：**
- 純文字，約 300 字
- 不包含 Markdown 格式
- 包含依戀類型判定（安全型/焦慮型/逃避型/恐懼-逃避型）

**範例：**
```
你在親密關係中的表現是...。根據你的星盤，你屬於**焦慮型依戀 (Anxious)**。你在關係中會...，你總是...。
```

**前端處理：**
- 直接顯示純文字內容
- 可以識別 `**文字**` 格式並加粗顯示（如果有的話）

---

### 2. `deep_analysis` - 星盤深度探索

**用途：** 顯示在「星盤深度探索」區域

**格式：**
- 純文字，約 1000 字
- 包含多個小標題，使用【標題】格式標記
- 每個小標題獨立一行
- 小標題後空一行再顯示內容

**範例：**
```
【內在靈魂】

你外表看似隨和，其實內心極度計較公平。你的月亮天秤讓你在做決定時會...

【處事風格】

你在工作中習慣...，你總是...，你會...。

【愛情與慾望】

你在戀愛中...，你對...的態度是...。
```

**前端處理要求：**

1. **小標題識別：**
   - 使用正則表達式識別：`【([^】]+)】`
   - 或直接匹配 `【` 和 `】` 之間的文字

2. **小標題顯示：**
   - 將【標題】內的文字（例如：「內在靈魂」）顯示為**黃色**
   - 或者將整個【標題】顯示為黃色
   - 每個小標題獨立一行

3. **內容顯示：**
   - 小標題後空一行再顯示內容
   - 內容使用正常文字顏色

**JavaScript 處理範例：**
```javascript
// 方法1：使用正則表達式替換
const processedText = deepAnalysis.replace(
  /【([^】]+)】/g,
  '<span style="color: yellow;">【$1】</span>'
);

// 方法2：更精細的處理（只將標題文字變黃）
const processedText = deepAnalysis.replace(
  /【([^】]+)】/g,
  '<span style="color: yellow;">$1</span>'
);
```

---

### 3. `houses_analysis` - 宮位分析（新增）

**用途：** 顯示12個宮位的性格特質分析

**格式：**
- 純文字，每一宮約100字，共12宮
- 包含12個小標題，使用【標題】格式標記（例如：【第1宮】、【第2宮】）
- 每個小標題獨立一行
- 小標題後空一行再顯示內容

**範例：**
```
【第1宮】

你在自我形象上...，你總是...，你會...。

【第2宮】

你在金錢和價值觀上...，你習慣...，你總是...。

【第3宮】

你在溝通和學習上...，你總是...，你會...。

（依此類推，共12個宮位）
```

**前端處理要求：**

1. **小標題識別：**
   - 使用正則表達式識別：`【([^】]+)】`
   - 匹配格式：【第X宮】

2. **小標題顯示：**
   - 將【標題】內的文字（例如：「第1宮」）顯示為**黃色**
   - 或者將整個【標題】顯示為黃色
   - 每個小標題獨立一行

3. **內容顯示：**
   - 小標題後空一行再顯示內容
   - 內容使用正常文字顏色

**JavaScript 處理範例：**
```javascript
// 處理宮位分析，將【標題】顯示為黃色
const processedHouses = housesAnalysis.replace(
  /【([^】]+)】/g,
  '<span style="color: yellow;">【$1】</span>'
);
```

**⚠️ 重要：文字風格要求**

後端 AI 已設定為**直接描述用戶特質**，不會解釋宮位含義。前端應該：

- ✅ **正確顯示**：直接顯示 AI 返回的內容即可
- ❌ **不要添加**：不要在前端自動生成「第X宮代表...」這類解釋性文字
- ❌ **不要修改**：不要修改或補充 AI 返回的內容

AI 會直接說「你在這個領域...」、「你總是...」、「你會...」，而不是「第X宮代表...」。

---

### 4. `chart.chinese.five_elements` - 五行能量數據

**路徑：** `response.chart.chinese.five_elements`

**格式：**
```json
{
  "金": 25,
  "木": 12,
  "水": 38,
  "火": 13,
  "土": 12
}
```

**說明：**
- ✅ **鍵名是中文**：`金`、`木`、`水`、`火`、`土`（不是英文的 Metal, Wood, Water, Fire, Earth）
- ✅ 所有值都是數字（0-100 的百分比）
- ✅ 總和應該接近 100（可能有四捨五入誤差）
- ⚠️ **重要**：後端已強制確保格式為中文，如果前端收到英文格式，請檢查數據路徑

**前端使用：**
```javascript
const fiveElements = response.chart.chinese.five_elements;

// 正確：使用中文鍵名
const jin = fiveElements.金;    // 金
const mu = fiveElements.木;     // 木
const shui = fiveElements.水;   // 水
const huo = fiveElements.火;    // 火
const tu = fiveElements.土;     // 土

// 或者使用方括號語法
const jin = fiveElements["金"];
const mu = fiveElements["木"];
// ...

// ❌ 錯誤：不要使用英文鍵名
// const metal = fiveElements.Metal;  // 這會是 undefined
```

**如果數據無法顯示，請檢查：**
1. 數據路徑是否正確：`response.chart.chinese.five_elements`
2. 鍵名是否使用中文：`金`、`木`、`水`、`火`、`土`
3. 數據是否存在：`console.log(response.chart.chinese.five_elements)`
4. 數據格式是否正確：應該是對象，不是數組或字符串

---

## ⚠️ 重要注意事項

### 1. 不要自動生成解釋性文字

**❌ 錯誤做法：**
根據 `chart.western.houses` 數據自動生成：
- 「第12宮 天秤座。落入天秤座的能量影響你如何處理隱藏的情感...」
- 「第X宮代表...」

**✅ 正確做法：**
- 直接使用 `houses_analysis` 的內容（如果存在）
- 直接使用 `deep_analysis` 的內容
- AI 已經直接描述了用戶的實際表現，不需要前端再生成解釋
- **重要**：AI 會直接說「你在這個領域...」、「你總是...」，而不是「第X宮代表...」

### 2. 向後兼容

- `ai_report` 字段仍然存在，內容與 `deep_analysis` 相同
- 如果前端仍在使用 `ai_report`，可以繼續使用
- **建議改用 `deep_analysis`**，因為這是新的標準字段

### 3. 數據驗證

- 確保 `five_elements` 存在且格式正確
- 如果 `attachment_analysis` 或 `deep_analysis` 為 `null`，顯示「分析中...」或錯誤訊息

---

## 📝 前端更新檢查清單

- [ ] 更新 API 響應處理，使用新的字段結構
- [ ] 實現 `attachment_analysis` 的顯示（依戀模式卡片）
- [ ] 實現 `deep_analysis` 的顯示（星盤深度探索區域）
- [ ] **新增**：實現 `houses_analysis` 的顯示（宮位分析區域）
- [ ] 實現【標題】格式的識別和黃色顯示（適用於 `deep_analysis` 和 `houses_analysis`）
- [ ] 更新五行能量數據的讀取路徑（`chart.chinese.five_elements`）
- [ ] **重要**：移除根據 `houses` 數據自動生成解釋性文字的邏輯
- [ ] **重要**：不要在前端添加「第X宮代表...」這類解釋性文字
- [ ] 測試所有新字段的顯示效果

---

## 🔍 測試建議

1. **測試五行能量顯示：**
   - 確認 `chart.chinese.five_elements` 數據正確顯示
   - 確認所有五個元素都有值

2. **測試依戀模式分析：**
   - 確認 `attachment_analysis` 正確顯示在對應卡片
   - 確認文字格式正確

3. **測試星盤深度探索：**
   - 確認 `deep_analysis` 正確顯示
   - 確認【標題】格式的小標題顯示為黃色
   - 確認小標題獨立一行，內容正確換行

4. **測試宮位分析：**
   - 確認 `houses_analysis` 正確顯示（如果存在）
   - 確認【第X宮】格式的小標題顯示為黃色
   - 確認每個宮位的內容正確換行

5. **測試錯誤處理：**
   - 測試當 `attachment_analysis` 或 `deep_analysis` 為 `null` 時的處理
   - 測試當 `houses_analysis` 為 `null` 時的處理
   - 測試當 `five_elements` 數據缺失時的處理

---

## 📞 如有問題

如有任何問題或需要進一步說明，請聯繫後端開發團隊。

